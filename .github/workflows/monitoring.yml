name: Monitoring (Drift)

on:
  workflow_dispatch:
  schedule:
    # Weekly on Sundays at 06:00 UTC
    - cron: "0 6 * * 0"

permissions:
  contents: read

concurrency:
  group: monitoring-drift-${{ github.ref }}
  cancel-in-progress: true

jobs:
  drift:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Create virtual environment
        run: |
          uv venv --python python3.11
          echo ".venv/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv pip uninstall -y ai-model-quality-framework || true
          uv pip install --no-cache-dir -e ".[monitoring]"
          uv pip install pyarrow

      - name: Ensure output directories exist
        run: |
          mkdir -p artifacts/monitoring artifacts/reports artifacts/models/v1 data/processed

      - name: Verify CI sample exists
        run: |
          test -f data/raw/sample/true.csv
          test -f data/raw/sample/fake.csv

      - name: Ingest CI sample dataset
        run: |
          python scripts/ingest_isot.py \
            --true-csv data/raw/sample/true.csv \
            --fake-csv data/raw/sample/fake.csv \
            --config configs/data_ci.yaml \
            --out data/processed/isot.parquet \
            --manifest artifacts/reports/split_manifest.json \
            --report artifacts/reports/data_validation.json
          test -f data/processed/isot.parquet

      - name: Train v1 model (required for prediction drift)
        run: |
          python scripts/train_v1.py \
            --dataset data/processed/isot.parquet \
            --eval-config configs/eval_ci.yaml \
            --out-dir artifacts/models/v1
          test -f artifacts/models/v1/model.joblib
          test -f artifacts/models/v1/vectorizer.joblib

      - name: Run data drift detection
        run: |
          python scripts/run_drift_report.py \
            --dataset data/processed/isot.parquet \
            --baseline-split train \
            --current-split test \
            --out artifacts/monitoring/drift_report.json
          test -f artifacts/monitoring/drift_report.json

      - name: Run prediction drift detection
        run: |
          python scripts/run_prediction_drift.py \
            --dataset data/processed/isot.parquet \
            --baseline-split train \
            --current-split test \
            --model-dir artifacts/models/v1 \
            --out artifacts/monitoring/pred_drift_report.json
          test -f artifacts/monitoring/pred_drift_report.json

      - name: Upload monitoring artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-artifacts
          if-no-files-found: warn
          retention-days: 14
          path: |
            artifacts/monitoring/**
            artifacts/reports/**
            artifacts/models/v1/**
            data/processed/isot.parquet

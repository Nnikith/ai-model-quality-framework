name: Monitoring (Drift)

on:
  workflow_dispatch:
  schedule:
    # Weekly on Sundays at 06:00 UTC
    - cron: "0 6 * * 0"

jobs:
  drift:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Create virtual environment
        run: |
          uv venv --python python3.11
          echo ".venv/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv pip install -e ".[monitoring]"
          # parquet reader for pandas
          uv pip install pyarrow

      - name: Debug sample files exist
        run: |
          ls -la data/raw/sample
          test -f data/raw/sample/true.csv
          test -f data/raw/sample/fake.csv

      - name: Generate processed dataset (CI sample)
        run: |
          python scripts/ingest_isot.py \
            --true-csv data/raw/sample/true.csv \
            --fake-csv data/raw/sample/fake.csv \
            --config configs/data_ci.yaml \
            --out data/processed/isot.parquet \
            --manifest artifacts/reports/split_manifest.json \
            --report artifacts/reports/data_validation.json

      - name: Run data drift report
        run: |
          python scripts/run_drift_report.py --out artifacts/monitoring/drift_report.json

      - name: Run prediction drift report
        run: |
          python scripts/run_prediction_drift.py --out artifacts/monitoring/pred_drift_report.json

      - name: Upload monitoring reports
        uses: actions/upload-artifact@v4
        with:
          name: drift-reports
          path: |
            artifacts/monitoring/drift_report.json
            artifacts/monitoring/pred_drift_report.json
            artifacts/reports/data_validation.json
            artifacts/reports/split_manifest.json
